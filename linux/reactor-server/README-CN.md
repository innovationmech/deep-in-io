# Reactor 服务器

基于 C 语言实现的高性能多线程 Reactor 模式服务器，使用 epoll 进行 Linux 系统下的事件驱动 I/O。

## 特性

- **多线程 Reactor 模式**：I/O 线程和工作线程分离，实现最佳性能
- **边缘触发 Epoll**：高效的事件驱动 I/O 处理
- **线程池**：可配置的工作线程池用于请求处理
- **连接负载均衡**：使用轮询方式在多个 I/O 线程间分发连接
- **非阻塞 I/O**：所有套接字操作均为非阻塞，实现最大并发性

## 架构设计

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   主线程    │────│  I/O线程    │────│  工作线程池 │
│  (接受连接) │    │  (epoll)    │    │  (处理请求) │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       │            ┌─────────────┐    ┌─────────────┐
       └────────────│  I/O线程    │    │  全局队列   │
                    │  (epoll)    │────│  (任务队列) │
                    └─────────────┘    └─────────────┘
```

## 组件说明

### 核心文件
- `main.c` - 主服务器入口点和连接接受
- `io_thread.c/h` - I/O 线程实现，包含 epoll 事件处理
- `thread_pool.c/h` - 用于请求处理的工作线程池
- `global_queue.c/h` - 线程安全的全局任务队列
- `conn_map.c/h` - 连接到缓冲区的映射，用于响应处理
- `util.c/h` - 工具函数（非阻塞套接字设置、错误处理）

### 配置参数
- `PORT`: 服务器监听端口（默认：8888）
- `MAX_IO_THREADS`: I/O 线程数量（默认：4）
- `MAX_WORKER_THREADS`: 工作线程数量（默认：1）
- `MAX_TASKS`: 全局队列最大任务数（默认：1024）

## 构建和运行

### 前置要求
- GCC 编译器
- 支持 epoll 的 Linux 系统
- pthread 库

### 构建
```bash
make clean
make
```

### 运行
```bash
./reactor-server
```

服务器将开始在 8888 端口监听。

### 测试
```bash
# 使用 telnet 连接
telnet localhost 8888

# 发送消息
hello world
test message
```

## 工作原理

1. **主线程**：接受新连接并使用轮询方式将其分发给 I/O 线程
2. **I/O 线程**：使用边缘触发模式的 epoll 处理套接字事件
   - 从客户端连接读取传入数据
   - 将接收的数据添加到全局任务队列
   - 处理向客户端写回响应
3. **工作线程**：从全局队列处理任务
   - 为接收的消息生成回显响应
   - 将接收的消息打印到控制台
4. **全局队列**：I/O 线程和工作线程间通信的线程安全任务队列

## 关键设计决策

- **简化内存管理**：使用静态数组而非动态分配，避免内存泄漏
- **全局任务队列**：用简单的全局队列替代复杂的线程间通信
- **轮询而非条件变量**：使用轮询避免 pthread 条件变量问题
- **边缘触发 Epoll**：通过每个事件处理所有可用数据来最大化性能

## 性能特征

- 高效处理多个并发连接
- 非阻塞 I/O 防止线程阻塞
- 多个 I/O 线程间的负载均衡
- 基于工作负载的可配置线程池大小

## 限制

- 目前仅实现简单的回显功能
- 响应写入较为基础（无复杂缓冲）
- 固定大小的全局任务队列
- 无优雅关闭机制

## 未来改进

- 实现适当的响应队列和写入机制
- 添加配置文件支持
- 添加日志系统
- 实现优雅关闭
- 添加连接超时和清理
- 性能监控和统计
